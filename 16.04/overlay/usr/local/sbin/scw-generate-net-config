#! /bin/bash

find /etc/network/interfaces.d/ -not -name "*.user.cfg" -type f -delete
for iface in $(ls /sys/class/net); do
    # Only configure physical interfaces
    if readlink /sys/class/net/$iface | grep --invert-match --silent 'virtual'; then
        echo """# Generated by $(basename $0)
auto $iface
iface $iface inet dhcp
iface $iface inet6 auto
""" > /etc/network/interfaces.d/$iface.cfg
    fi

if [ -z $(scw-metadata IPV6_ADDRESS) ]
    then
        exit
    else
      # Import all IPv6 configuration from the metadata service
      IPV6_NETMASK=$(scw-metadata IPV6_NETMASK)
      IPV6_GATEWAY=$(scw-metadata IPV6_GATEWAY)
      IPV6_ADDRESS=$(scw-metadata IPV6_ADDRESS)
      # Configure IPv6
      ip addr add ${IPV6_ADDRESS}/${IPV6_NETMASK} dev $iface
      # Add the default IPv6 gateway
      ip -6 r add default via ${IPV6_GATEWAY} dev $iface
fi
done
